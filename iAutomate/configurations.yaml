# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# DeploymentManagerTemplate specifies the location that a deployment manager
# template is generated when `mpdev apply` is invoked
apiVersion: dev.marketplace.cloud.google.com/v1alpha1
kind: DeploymentManagerTemplate
metadata:
  name: dmtemplate
deploymentManagerRef:
  group: dev.marketplace.cloud.google.com
  kind: DeploymentManagerAutogenTemplate
  name: autogen
zipFilePath: template.zip # {"$kpt-set":"zipPath"}
---
# DeploymentManagerAutogenTemplate auto-generates a deployment manager template
# that can be deployed using `gcloud deployments create ...`
apiVersion: dev.marketplace.cloud.google.com/v1alpha1
kind: DeploymentManagerAutogenTemplate
metadata:
  name: autogen
spec:
  # See https://pkg.go.dev/github.com/GoogleCloudPlatform/marketplace-tools/mpdev/internal/apply?tab=doc#PackageInfo
  packageInfo:
    version: '1.0'
    osInfo:
      name: Debian
      version: '9.12'
    components:
    - name: iautomatewindowvmweb,
      version: '1.0'
    - name: iautomatewindowvmapp,
      version: '1.0'
    - name: iautomatewindowvmsql,
      version: '1.0'
    - name: iautomatevm,
      version: '1.0'
  # See https://github.com/GoogleCloudPlatform/marketplace-tools/docs/autogen-reference.md
  # for explanation of fields
  deploymentSpec:
    multiVm:
      zone: 
      - default_zone: us-west1-b
      tiers:
      - name: iautomatewindowvmweb
        title: iautomatewindowvmweb
        bootDisk:
          diskSize:
            defaultSizeGb: 80
            minSizeGb: 80
            sourceImage: https://www.googleapis.com/compute/v1/projects/windows-cloud/global/images/windows-server-2016-dc-v20201208
          diskType:
            defaultType: pd-standard
        gceMetadataItems:
        items:
      - key: sysprep-specialize-script-ps1
        value: |
         $Password = "Qazxsw@123" | ConvertTo-SecureString -AsPlainText -Force 
         New-LocalUser "AdministratorAnsible" -Password $Password -FullName "AdministratorAnsible" -Description "Description of this account." 
         Add-LocalGroupMember -Group "Administrators" -Member "AdministratorAnsible"
         write-output "Running User Data Script" >> test.txt
         write-host "(host) Running User Data Script"
         cmd.exe /c winrm quickconfig -q 
         cmd.exe /c winrm quickconfig '-transport:http'
         cmd.exe /c winrm set "winrm/config" '@{MaxTimeoutms="1800000"}'
         cmd.exe /c winrm set "winrm/config/winrs" '@{MaxMemoryPerShellMB="512"}'
         cmd.exe /c winrm set "winrm/config/service" '@{AllowUnencrypted="true"}'
         cmd.exe /c winrm set "winrm/config/client" '@{AllowUnencrypted="true"}'
         cmd.exe /c winrm set "winrm/config/service/auth" '@{Basic="true"}'
         cmd.exe /c winrm set "winrm/config/client/auth" '@{Basic="true"}'
         cmd.exe /c winrm set "winrm/config/service/auth" '@{CredSSP="true"}'
         cmd.exe /c winrm set "winrm/config/listener?Address=*+Transport=HTTP" '@{Port="5985"}'
         cmd.exe /c netsh advfirewall firewall set rule group="remote administration" new enable=yes
         cmd.exe /c netsh firewall add portopening TCP 5985 "Port 5985"
         cmd.exe /c net stop winrm
         cmd.exe /c sc config winrm start= auto
         cmd.exe /c net start winrm
         cmd.exe /c net user Administrator Qazxsw@123
         cmd.exe /c net user administrator /active:yes         
    tags:
      items:
      - http
    #serviceAccounts:
    #- email: siddharth-c@dryicepoc-242713.iam.gserviceaccount.com
      gcpAuthScopes:
      - https://www.googleapis.com/auth/devstorage.read_only
      - https://www.googleapis.com/auth/logging.write
      - https://www.googleapis.com/auth/monitoring.write
      - https://www.googleapis.com/auth/servicecontrol
      - https://www.googleapis.com/auth/service.management.readonly
        machineType:
          defaultMachineType:
            gceMachineType: e2-standard-4
        networkInterfaces:
           minCount: 1
    #      accessConfigs:
     #     - name: External NAT
    #         type: ONE_TO_ONE_NAT